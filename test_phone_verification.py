#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
–ó–∞–ø—É—Å–∫: python test_phone_verification.py
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from tools.client_tools import normalize_phone, find_clients_by_phone


def test_normalize_phone():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤"""
    
    print("üß™ –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤\n")
    print("="*60)
    
    test_cases = [
        ("+79001234567", "+79001234567"),
        ("89001234567", "+79001234567"),
        ("9001234567", "+79001234567"),
        ("+7 900 123 45 67", "+79001234567"),
        ("8 (900) 123-45-67", "+79001234567"),
        ("+7-900-123-45-67", "+79001234567"),
        ("8-900-123-45-67", "+79001234567"),
        ("+7 (900) 123 45 67", "+79001234567"),
    ]
    
    passed = 0
    failed = 0
    
    for input_phone, expected in test_cases:
        result = normalize_phone(input_phone)
        status = "‚úÖ" if result == expected else "‚ùå"
        
        if result == expected:
            passed += 1
        else:
            failed += 1
        
        print(f"{status} {input_phone:25} ‚Üí {result:15} (–æ–∂–∏–¥–∞–ª–æ—Å—å: {expected})")
    
    print("\n" + "="*60)
    print(f"–ü—Ä–æ–π–¥–µ–Ω–æ: {passed}/{len(test_cases)}")
    
    if failed > 0:
        print(f"‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {failed}")
        return False
    else:
        print("üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!")
        return True


def test_find_clients_by_phone():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"""
    
    print("\n\nüß™ –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É\n")
    print("="*60)
    
    # –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –±–∞–∑—ã (–±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è)
    # –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –±–∞–∑—ã
    test_phone = "+79068609037"  # –ò–∑ –ø—Ä–∏–º–µ—Ä–∞ –≤ clients.json
    
    print(f"\nüìù –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É {test_phone}")
    result = find_clients_by_phone(test_phone)
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç:\n{result}\n")
    
    if "‚ùå" in result:
        print("‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ –±–∞–∑–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)")
    elif "verify_candidate" in result or "verify_candidates" in result:
        print("‚úÖ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏")
    
    # –¢–µ—Å—Ç —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
    print("\nüìù –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
    fake_phone = "+79999999999"
    result = find_clients_by_phone(fake_phone)
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç:\n{result}\n")
    
    if "‚ùå" in result and "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã" in result:
        print("‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
    else:
        print("‚ùå –û—à–∏–±–∫–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –¢–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    print("\nüìù –¢–µ—Å—Ç 3: –ü–æ–∏—Å–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –Ω–æ–º–µ—Ä–∞")
    formats = [
        "+79068609037",
        "89068609037",
        "9068609037",
        "+7 906 860 90 37",
    ]
    
    results_match = True
    first_result = None
    
    for phone in formats:
        result = find_clients_by_phone(phone)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if first_result is None:
            first_result = result
        elif result != first_result:
            results_match = False
            print(f"‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è {phone} –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø–µ—Ä–≤—ã–º")
    
    if results_match:
        print("‚úÖ –í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–∞ –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
    
    print("\n" + "="*60)
    print("üéâ –¢–µ—Å—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∑–∞–≤–µ—Ä—à–µ–Ω—ã!")


if __name__ == "__main__":
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        normalize_ok = test_normalize_phone()
        test_find_clients_by_phone()
        
        print("\n\n" + "="*60)
        if normalize_ok:
            print("üèÜ –í–°–ï –¢–ï–°–¢–´ –£–°–ü–ï–®–ù–û –ü–†–û–ô–î–ï–ù–´!")
        else:
            print("‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏")
        print("="*60)
        
        sys.exit(0 if normalize_ok else 1)
    except Exception as e:
        print(f"\n‚ùå –ù–ï–ü–†–ï–î–í–ò–î–ï–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
