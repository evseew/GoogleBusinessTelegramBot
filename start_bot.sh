#!/bin/bash

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p logs
mkdir -p logs/context_logs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç (–ø–æ bot.pid –∏ –ø–æ –ø—Ä–æ—Ü–µ—Å—Å—É)
if [ -f bot.pid ]; then
    PID=$(cat bot.pid)
    if ps -p $PID > /dev/null; then
        echo "‚ö†Ô∏è –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (–ø–æ bot.pid) —Å PID: $PID"
        echo "–î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./restart.sh"
        exit 1
    else
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID —Ñ–∞–π–ª, —É–¥–∞–ª—è–µ–º..."
        rm -f bot.pid
    fi
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –ø–æ –ø—Ä–æ—Ü–µ—Å—Å—É (–µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –µ—Å—Ç—å, –Ω–æ bot.pid –Ω–µ—Ç)
if pgrep -f "python.*bot.py" > /dev/null; then
    EXIST_PID=$(pgrep -f "python.*bot.py" | head -n 1)
    echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ (–ø–æ pgrep), PID: $EXIST_PID"
    echo "–î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./restart.sh"
    exit 1
fi

# –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é
echo "üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ: $(pwd)/new_venv"

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
source "$(pwd)/new_venv/bin/activate"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if ! python3 -c "import openai" &> /dev/null; then
    echo "‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ OpenAI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    pip install openai
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
pip install langchain-huggingface

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ .env
if [ ! -f .env ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–Ω—ã–π —Ü–∏–∫–ª —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ –±–æ—Ç–∞..."
source .env

# –õ–æ–≤–∏–º —Å–∏–≥–Ω–∞–ª—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å
terminate() {
  echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
  if [ -n "$CHILD_PID" ] && ps -p $CHILD_PID > /dev/null; then
    kill -15 $CHILD_PID
    # –∂–¥–µ–º –¥–æ 10—Å
    for i in {1..10}; do
      if ! ps -p $CHILD_PID > /dev/null; then
        break
      fi
      sleep 1
    done
    if ps -p $CHILD_PID > /dev/null; then
      echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞"
      kill -9 $CHILD_PID
    fi
  fi
  rm -f bot.pid
  exit 0
}
trap terminate INT TERM

echo $$ > bot.pid
echo "‚úÖ –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä –∑–∞–ø—É—â–µ–Ω, PID: $$"

RESTART_DELAY=5
while true; do
  echo "‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç bot.py..."
  nohup python3 bot.py >> logs/bot.log 2>&1 &
  CHILD_PID=$!
  echo "üë∂ –î–æ—á–µ—Ä–Ω–∏–π PID: $CHILD_PID"

  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  wait $CHILD_PID
  EXIT_CODE=$?
  echo "‚ö†Ô∏è bot.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º: $EXIT_CODE. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ ${RESTART_DELAY}s..." | tee -a logs/bot.log
  sleep $RESTART_DELAY
done