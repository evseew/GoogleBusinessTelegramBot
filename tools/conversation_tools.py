"""
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
—Å –∫–ª–∏–µ–Ω—Ç–æ–º, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–º –ø—Ä–æ–¥—É–∫—Ç–µ.
"""
import logging
from typing import Dict, Any, Optional

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–µ–º –¥–∏–∞–ª–æ–≥–∞
# –§–æ—Ä–º–∞—Ç: {telegram_user_id: "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã"}
_conversation_topics: Dict[int, str] = {}

# –¢–µ–∫—É—â–∏–π user_id –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º tool)
_current_user_id: Optional[int] = None


def set_current_user_id(user_id: int):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π user_id –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è tool.
    
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ bot.py –ø–µ—Ä–µ–¥ execute_tool_call, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏–∏
    –∑–Ω–∞–ª–∏, –¥–ª—è –∫–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.
    
    Args:
        user_id: Telegram user ID
    """
    global _current_user_id
    _current_user_id = user_id


def set_conversation_topic(topic: str) -> Dict[str, Any]:
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.
    
    üéØ –ö–û–ì–î–ê –í–´–ó–´–í–ê–¢–¨:
    - –ö–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É: "—Ö–æ—á—É –º–∞—Ç–µ–º–∞—Ç–∏–∫—É" ‚Üí topic="–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ STEM"
    - –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥—É—é —Ç–µ–º—É: "–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —ë–ª–∫–∏" ‚Üí topic="–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —ë–ª–∫–∏"
    - –ö–ª–∏–µ–Ω—Ç —É—Ç–æ—á–Ω—è–µ—Ç: "–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π" ‚Üí topic="–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"
    
    üìö –ü–†–ò–ú–ï–†–´ –¢–ï–ú:
    - "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"
    - "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ STEM" 
    - "–∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫"
    - "–≥–æ—Ä–æ–¥—Å–∫–æ–π –ª–∞–≥–µ—Ä—å"
    - "–∑–∞–≥–æ—Ä–æ–¥–Ω—ã–π –ª–∞–≥–µ—Ä—å"
    - "–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —ë–ª–∫–∏"
    - "–º–µ—Ä—á"
    - "–ø—Ä–æ–±–Ω—ã–µ —ç–∫–∑–∞–º–µ–Ω—ã –û–ì–≠/–ï–ì–≠"
    - "–∫–∏–Ω–æ–ø–æ–∫–∞–∑—ã"
    - "–≤–∏–∫—Ç–æ—Ä–∏–Ω—ã"
    
    ‚ö†Ô∏è –ù–ï –í–´–ó–´–í–ê–ô –ø—Ä–∏:
    - –û–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö ("–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "—Å–ø–∞—Å–∏–±–æ")
    - –£—Ç–æ—á–Ω–µ–Ω–∏—è—Ö –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã ("—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?", "–∫–∞–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?")
    - –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞)
    
    üí° –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ü–†–û–î–£–ö–¢–´:
    –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥ ("–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É, –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π"),
    –ù–ï –≤—ã–∑—ã–≤–∞–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –°–ü–†–û–°–ò —É –∫–ª–∏–µ–Ω—Ç–∞:
    "–ö–∞–∫–∞—è –∏–∑ —É—Å–ª—É–≥ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?"
    
    Args:
        topic: –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –µ—ë –Ω–∞–∑—ã–≤–∞–µ—Ç)
    
    Returns:
        {
            "success": True,
            "topic": "...",
            "message": "...",
            "previous_topic": "..." | None
        }
    """
    if not _current_user_id:
        logger.error("set_conversation_topic –≤—ã–∑–≤–∞–Ω –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ user_id!")
        return {
            "success": False,
            "error": "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã."
        }
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–º—É (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã)
    normalized_topic = " ".join(topic.strip().split())
    
    if not normalized_topic:
        return {
            "success": False,
            "error": "–¢–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π"
        }
    
    old_topic = _conversation_topics.get(_current_user_id)
    _conversation_topics[_current_user_id] = normalized_topic
    
    if old_topic and old_topic != normalized_topic:
        logger.info(f"üéØ User {_current_user_id}: —Ç–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ —Å '{old_topic}' –Ω–∞ '{normalized_topic}'")
        message = f"–¢–µ–º–∞ –¥–∏–∞–ª–æ–≥–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: {normalized_topic}. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ–π —É—Å–ª—É–≥–µ."
    elif old_topic == normalized_topic:
        logger.debug(f"‚úÖ User {_current_user_id}: —Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ '{normalized_topic}'")
        message = f"–¢–µ–º–∞ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞: {normalized_topic}."
    else:
        logger.info(f"üÜï User {_current_user_id}: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ç–µ–º–∞ '{normalized_topic}'")
        message = f"–¢–µ–º–∞ –¥–∏–∞–ª–æ–≥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {normalized_topic}."
    
    return {
        "success": True,
        "topic": normalized_topic,
        "previous_topic": old_topic,
        "message": message
    }


def get_conversation_topic(user_id: int) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        user_id: Telegram user ID
    
    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –∏–ª–∏ None, –µ—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    """
    return _conversation_topics.get(user_id)


def clear_conversation_topic(user_id: int):
    """
    –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /reset –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
    
    Args:
        user_id: Telegram user ID
    """
    if user_id in _conversation_topics:
        old_topic = _conversation_topics[user_id]
        del _conversation_topics[user_id]
        logger.info(f"üîÑ User {user_id}: —Ç–µ–º–∞ –¥–∏–∞–ª–æ–≥–∞ '{old_topic}' –æ—á–∏—â–µ–Ω–∞")
        return True
    return False


def get_all_topics() -> Dict[int, str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–º—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã /list_verifications).
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å {user_id: topic}
    """
    return _conversation_topics.copy()


# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ tool –¥–ª—è Responses API ---

CONVERSATION_TOPIC_FUNCTION_NAME = "set_conversation_topic"


def get_conversation_topic_tool_for_responses_api() -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ set_conversation_topic –¥–ª—è Responses API.
    
    –§–æ—Ä–º–∞—Ç Responses API –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç Chat Completions API.
    """
    return {
        "type": "function",
        "name": CONVERSATION_TOPIC_FUNCTION_NAME,
        "description": (
            "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. "
            "–í—ã–∑—ã–≤–∞–π –ö–ê–ñ–î–´–ô –†–ê–ó, –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥—É—é —Ç–µ–º—É.\n\n"
            "üéØ –ö–û–ì–î–ê –í–´–ó–´–í–ê–¢–¨:\n"
            "- –ö–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç —É—Å–ª—É–≥—É: '—Ö–æ—á—É –º–∞—Ç–µ–º–∞—Ç–∏–∫—É' ‚Üí topic='–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ STEM'\n"
            "- –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è: '–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —ë–ª–∫–∏' ‚Üí topic='–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —ë–ª–∫–∏'\n"
            "- –ö–ª–∏–µ–Ω—Ç —É—Ç–æ—á–Ω—è–µ—Ç: '–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π' ‚Üí topic='–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫'\n\n"
            "üìö –ü–†–ò–ú–ï–†–´ –¢–ï–ú:\n"
            "- '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ STEM', '–∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫'\n"
            "- '–≥–æ—Ä–æ–¥—Å–∫–æ–π –ª–∞–≥–µ—Ä—å', '–∑–∞–≥–æ—Ä–æ–¥–Ω—ã–π –ª–∞–≥–µ—Ä—å'\n"
            "- '–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —ë–ª–∫–∏', '–º–µ—Ä—á', '–ø—Ä–æ–±–Ω—ã–µ —ç–∫–∑–∞–º–µ–Ω—ã –û–ì–≠/–ï–ì–≠'\n\n"
            "‚ö†Ô∏è –ù–ï –í–´–ó–´–í–ê–ô –ø—Ä–∏:\n"
            "- –û–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö ('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', '—Å–ø–∞—Å–∏–±–æ')\n"
            "- –£—Ç–æ—á–Ω–µ–Ω–∏—è—Ö –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã ('—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?', '–∫–∞–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?')\n\n"
            "üí° –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ü–†–û–î–£–ö–¢–´:\n"
            "–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥ ('–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É, –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π'), "
            "–ù–ï –≤—ã–∑—ã–≤–∞–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –°–ü–†–û–°–ò —É –∫–ª–∏–µ–Ω—Ç–∞: "
            "'–ö–∞–∫–∞—è –∏–∑ —É—Å–ª—É–≥ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?'"
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "topic": {
                    "type": "string",
                    "description": (
                        "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –µ—ë –Ω–∞–∑—ã–≤–∞–µ—Ç). "
                        "–ü—Ä–∏–º–µ—Ä—ã: '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ STEM', '–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —ë–ª–∫–∏', '–º–µ—Ä—á', '–ø—Ä–æ–±–Ω—ã–µ —ç–∫–∑–∞–º–µ–Ω—ã –û–ì–≠/–ï–ì–≠'"
                    )
                }
            },
            "required": ["topic"]
        }
    }

