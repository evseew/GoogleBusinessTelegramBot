#!/bin/bash

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
stop_bot() {
    local pid=$1
    echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ —Å PID: $pid"
    
    # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    kill -15 $pid
    
    # –ñ–¥–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    for i in {1..10}; do
        if ! ps -p $pid > /dev/null; then
            echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            return 0
        fi
        echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞... $i/10"
        sleep 1
    done
    
    # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å—ë –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–º–µ–Ω—è–µ–º SIGKILL
    if ps -p $pid > /dev/null; then
        echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ"
        kill -9 $pid
        sleep 1
        
        if ! ps -p $pid > /dev/null; then
            echo "‚úÖ –ë–æ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            return 0
        else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"
            return 1
        fi
    fi
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
if [ -f bot.pid ]; then
    echo "üîç –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª bot.pid"
    PID=$(cat bot.pid)
    
    if ps -p $PID > /dev/null; then
        stop_bot $PID
        if [ $? -eq 0 ]; then
            rm bot.pid
        fi
    else
        echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω"
        rm bot.pid
        echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ñ–∞–π–ª bot.pid"
    fi
else
    echo "‚ö†Ô∏è –§–∞–π–ª bot.pid –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ..."
    PIDS=$(pgrep -fa "$SCRIPT_DIR/bot.py" | awk '{print $1}' || true)
    if [ -n "$PIDS" ]; then
        echo "üîç –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞: $PIDS"
        for PID in $PIDS; do
            stop_bot $PID
        done
    else
        echo "‚ÑπÔ∏è –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω."
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏)
if pgrep -fa "$SCRIPT_DIR/bot.py" > /dev/null; then
    echo "‚ùå –í–Ω–∏–º–∞–Ω–∏–µ! –ë–æ—Ç –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤—Ä—É—á–Ω—É—é."
else
    echo "‚úÖ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω."
fi 